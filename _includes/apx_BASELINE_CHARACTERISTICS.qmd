### SSPI-2

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: tbl-sspi-2
#| tbl-cap: "SSPI-2. Note, that the SSPI-2 is only defined for participants who have at least one hands-on offences."

calculate_sspi <- function(df) {

  # umcodierung der items zum berechnen
  df <- df %>% mutate(sspi_irgendein_maennliches_opfer_unter_15jahre = case_when(indexirgend == "Ja" ~ 1,
                                                                                      indexirgend == "Nein" ~ 0,
                                                                                      TRUE ~ NA_real_))

  df <- df %>% mutate(sspi_mehrere_opfer_unter_15jahre = case_when(indexmehropf == "Ja" ~ 1,
                                                                        indexmehropf == "Nein" ~ 0,
                                                                        TRUE ~ NA_real_))
  
  df <- df %>% mutate(sspi_irgendein_opfer_unter_12jahre = case_when(indexirgendopf == "Ja" ~ 1,
                                                                          indexirgendopf == "Nein" ~ 0,
                                                                          TRUE ~ NA_real_))
  df <- df %>% mutate(sspi_irgendein_nicht_zur_familie_gehoerendes_opfer_unter15jahre = case_when(indexnichtfam == "Ja" ~ 1,
                                                                                                      indexnichtfam == "Nein" ~ 0,
                                                                                                      TRUE ~ NA_real_))
  df <- df %>% mutate(sspi_irgendein_besitz_von_kinderpornographie = case_when(vsbesitz == "Ja" ~ 1,
                                                                                  vsbesitz == "Nein" ~ 0,
                                                                                  TRUE ~ NA_real_))
  # sspi-2 score auf aktenbasis (auch bei personen mit unvollstaendigen items)
  df <- df %>% mutate(calc_sspi_score = rowSums(across(c(sspi_irgendein_maennliches_opfer_unter_15jahre, 
                                                        sspi_mehrere_opfer_unter_15jahre, 
                                                        sspi_irgendein_opfer_unter_12jahre, 
                                                        sspi_irgendein_nicht_zur_familie_gehoerendes_opfer_unter15jahre,
                                                        sspi_irgendein_besitz_von_kinderpornographie))
                                                        ))
                                                        
  #sspi score ist nur sinnvoll bei personen, die eine straftat nach §§ 176 stgb ff. begangen haben
  df <- df %>% mutate(calc_sspi_score = case_when(strataindex != "Auch §§ 176, 176a, 176b StGB" ~ NA,
                                                  indexirgend == "keine Angabe"  ~ NA, 
                                                  indexmehropf == "keine Angabe"  ~ NA,
                                                  indexirgendopf == "keine Angabe" ~ NA,
                                                  indexnichtfam == "keine Angabe" ~ NA,
                                                  TRUE ~ calc_sspi_score))

  return(df)
}

sspi <- data %>%
    select(
        strataindex,
        indexirgend,
        indexmehropf,
        indexirgendopf,
        indexnichtfam,
        vsbesitz,
        sspi_irgendein_besitz_von_kinderpornographie,
        sspi_mehrere_opfer_unter_15jahre,
        sspi_irgendein_maennliches_opfer_unter_15jahre,
        sspi_irgendein_opfer_unter_12jahre,
        sspi_irgendein_nicht_zur_familie_gehoerendes_opfer_unter15jahre,
        client_group,
        indexnichtfam
    )

sspi <- calculate_sspi(sspi) %>%
    select(
        -strataindex,
        -indexirgend,
        -indexmehropf,
        -indexirgendopf,
        -indexnichtfam,
        -vsbesitz
    ) %>%
    mutate(
        sspi_irgendein_besitz_von_kinderpornographie = factor(sspi_irgendein_besitz_von_kinderpornographie, levels = c(1, 0), labels = c("Yes", "No")),
        sspi_mehrere_opfer_unter_15jahre = factor(sspi_mehrere_opfer_unter_15jahre, levels = c(1, 0), labels = c("Yes", "No")),
        sspi_irgendein_maennliches_opfer_unter_15jahre = factor(sspi_irgendein_maennliches_opfer_unter_15jahre, levels = c(1, 0), labels = c("Yes", "No")),
        sspi_irgendein_opfer_unter_12jahre = factor(sspi_irgendein_opfer_unter_12jahre, levels = c(1, 0), labels = c("Yes", "No")),
        sspi_irgendein_nicht_zur_familie_gehoerendes_opfer_unter15jahre = factor(sspi_irgendein_nicht_zur_familie_gehoerendes_opfer_unter15jahre, levels = c(1, 0), labels = c("Yes", "No"))
    )

tbl <- sspi %>%
    tbl_summary(
        by = client_group,
        type = list(
            sspi_irgendein_besitz_von_kinderpornographie  ~ "categorical",
            sspi_mehrere_opfer_unter_15jahre  ~ "categorical",
            sspi_irgendein_maennliches_opfer_unter_15jahre  ~ "categorical",
            sspi_irgendein_opfer_unter_12jahre  ~ "categorical",
            sspi_irgendein_nicht_zur_familie_gehoerendes_opfer_unter15jahre  ~ "categorical",
            calc_sspi_score  ~ "continuous2"
        ),
        label = list(
            sspi_irgendein_besitz_von_kinderpornographie = "Any hands-off offences",
            sspi_mehrere_opfer_unter_15jahre = "More than one hands-on victims",
            sspi_irgendein_maennliches_opfer_unter_15jahre  = "Any hands-on victims under 15 years old",
            sspi_irgendein_opfer_unter_12jahre  = "Any hands-on victims under 12 years old",
            sspi_irgendein_nicht_zur_familie_gehoerendes_opfer_unter15jahre  = "Any extra-familiar hands-on victims",
            calc_sspi_score = "SSPI-2 score"
        ),
        missing_text = "Missing"
    ) %>%
    add_overall() %>%
    bold_labels() %>%
    as_gt() %>%
    gt::tab_options(
      #table.font.names = "Source Sans Pro",
      table.font.size = 12,
      quarto.use_bootstrap = FALSE,
      quarto.disable_processing = TRUE,
      data_row.padding = px(2),
      summary_row.padding = gt::px(2),
      grand_summary_row.padding = gt::px(2),
      #footnotes.padding = gt::px(2),
      #source_notes.padding = gt::px(2),
      row_group.padding = gt::px(2)
    )

# save tbl as image
gt::gtsave(tbl, file = file.path(here::here("_tables/tbl-sspi-2.pdf")))
gt::gtsave(tbl, file = file.path(here::here("_tables/tbl-sspi-2.docx")))
gt::gtsave(tbl, file = file.path(here::here("_tables/tbl-sspi-2.png")))

tbl       
```

